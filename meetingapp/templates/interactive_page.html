{% extends "base.html" %}

{% block content %}

{% load static %}

{% if access %}

<link href="{% static "interactive.css" %}" rel="stylesheet" type="text/css">

<div class="container">
    <div class="row">
        <div class="span8">
            <div class="meetingHead">
                <h2 style="margin-bottom:20px !important;">{{m.title}}</h2>
                <div class="desc">
                    {{m.desc}}
                </div>
                <div class="info">
                    <text style="font-weight: bold !important;">Start: </text>
                    <text style="margin-left: 5px;">{{m.starttime}} {{m.startdate}}</text><br>
                    <text style="font-weight: bold !important;">End: </text>
                    <text style="margin-left: 5px;">{{m.endtime}} {{m.enddate}}</text><br>
                    <text style="font-weight: bold !important;">Timezone: </text>
		    <text style="margin-left: 5px;">{{m.timezone}}</text><br> 
		    {% if user == host.user %}
		    	<form method="post" style="margin-top: 20px !important;">{% csrf_token %}
                            <button class="btn btn-primary alter" type="submit" name="settings" style="padding: 4px !important; padding-left: 8px !important; padding-right: 8px !important;">Settings</button>
                			<button class="btn alter" type="submit" name="members" style="padding: 4px !important; padding-left: 8px !important; padding-right: 8px !important;">Manage Members</button>
    			</form>
			{% else %}	
			{% if m.friend_invites %}
				<br>
				<a class="cs_import btn" style="margin-top: 2px !important;">Invite friends from Address Book</a>
				<img src="{% static "google.png" %}" class="addrbook">
				<img src="{% static "apple.png" %}" class="addrbook">
				<img src="{% static "yahoo.png" %}" class="addrbook">
				<img src="{% static "aol.png" %}" class="addrbook">
				<img src="{% static "msn.png" %}" class="addrbook">
				<div class="row collapse out" id="collapse1" style="margin-left: 0px !important;">
					<form method="post" id="add_addr_book" style="margin:5 px; padding: 0px;">{% csrf_token %}
						<textarea name="addr_contacts" style="width:450px;height:82px" id="contact_list"></textarea><br>
						<button type="submit" class="btn btn-mini btn-primary">Invite to meeting</button>
					</form>
				</div>
				{% endif %}
			{% endif %}
			{% if user.is_authenticated %}
			<form method="post" style="margin-top: 20px !important;">{% csrf_token %}
                <i class="icon-envelope"></i>
				{% if currently_receiving %} You are currently receiving email notifications from this meeting. <br> Stop receiving notifications? 
				<button class="btn btn-mini" name="stop_emails" id="stop_emails">Stop</button>
				{% else %} You are currently not receiving email notifications from this meeting. <br> Start receiving notifications?
				<button class="btn btn-mini" name="get_emails" id="get_emails">Start</button>
				{% endif %}
				{% if notifications_modified %}
					<br><text style="font-style: italic;">
					{% if receiving %}
					Thanks! You will receive all notifications from this meeting.
					{% else %}
					Thanks! You won't receive any notifications from this meeting.
					{% endif %}</text>
				{% endif %}
			</form>
            {% if user == host.user %}
                {% if pending %}
                <form method="post" style="margin-top: 20px !important;">{% csrf_token %}
                    <i class="icon-envelope"></i> You have unsent email invites. Send these now? 
                    <button class="btn btn-mini" name="send_pending">Send</button>
                    {% if just_sent %}
                    <br>
                    Thanks! The emails were sent.
                    {% endif %}
                </form>
                {% endif %}
            {% endif %}

            {% else %}
            <br>
            <a href="#signinModal" data-toggle="modal" class="btn btn-primary">Invited to be interviewed? Click here to log in or sign up.</a>
            <br><br>
			{% endif %}
            {% if is_invitee %}
                {% if show_response_options %}
                    <form method="post" style="margin-top: 20px !important;">{% csrf_token %}
                        <h4 style="color: red;">You haven't yet responsed to this interview's invitation. Please choose an option:</h4>
                        <button class="btn btn-primary" name="accept">Accept</button>
                        <button class="btn btn-danger" name="decline">Decline</button>
                    </form>
                {% endif %}
                {% if response_message %}
                    {{response_message}}
                {% endif %}
            {% endif %}
                </div>
            </div>
        </div>
        <div class="span4">
            <div class="organizerHead">
                <h3 style="text-align: center; margin-bottom:5px !important;">{{org.name}}</h3>
                <div style="text-align: center; vertical-align: middle;">
                    {% if org.image %}<img src='{{org.image.url}}' />{% endif %}
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="span8">
            <p class="lead">Live Chat</p>

            <div class="row">
				<div id="menu">
					<p class="welcome">Welcome, <b>{{user.first_name}} {{user.last_name}}</b>
						{% if closed %}. Chat is currently closed.{% endif %}</p>
					{% if not closed %}
						<a data-toggle="modal" role="button" id="see_online_mems" href="#mems_online" style="float:right;">Members online: <span id="n_o">{{num_online}}</span></a>
						{% if canmod %}<a data-toggle="modal" role="button" id="see_bans" href="#bans" style="float:right; margin-right: 15px;">Ban/Un-ban Members</a>{% endif %}
					{% endif %}
					<div style="clear:both"></div>
				</div>

				<div id="chatbox">{% autoescape off %}{{chatlog}}{% endautoescape %}</div>

				<form name="message" action="">
					<input name="usermsg" type="text" id="usermsg" maxlength="200" size="63" />
					<input name="submitmsg" class="btn" type="button" id="submitmsg" value="Send" />
				</form>
			</div>
        </div>
        <div class="span4">
            {% if org %}
            <div class="userinfo" style="border: none !important; text-align: center;">
                <h5>About This Organization:</h5>
                <p>{{org.desc}}</p>
                <h5>Contact:</h5>
                <p>{{org.contact}}</p>
            </div>
            {% endif %}
            <div class="userinfo sidebox" style="height: 75px !important;">
                <i class="icon-user"></i>
                <text class="lead" style="font-size: 15px !important;">Host (1):</text><br>
                {% for member in m.hosts.all %}
                <text>{{member.user.last_name}}, {{member.user.first_name}} <<em>{{member.user.email}}</em>></text><br>
                {% endfor %}
            </div>
            <div class="userinfo sidebox" style="height: 350px !important;">
                <i class="icon-user"></i>
                <text class="lead" style="font-size: 15px !important;">Members ({{m.members.all.count}}):</text><br>
                {% for member in m.members.all %}
                <text>
                    <a href="/profile/{{member.page_id}}">
                    {{member.user.last_name}}, {{member.user.first_name}}</a> <<em>{{member.user.email}}</em>>
                </text><br>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<div id="myModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
    <h3 id="myModalLabel">Meeting Closed</h3>
  </div>
  <div class="modal-body">
    <p>This meeting is not currently open. Please consult the start/end times.</p>
  </div>
  <div class="modal-footer">
    <button type="button" data-dismiss="modal" class="btn btn-primary">Ok</button>
  </div>
</div>

<div id="mems_online" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="vModalLabel" aria-hidden="true">
  <div class="modal-header">
    <button type="button" class="close" id="close_online_mems2" data-dismiss="modal" aria-hidden="true">×</button>
    <h3 id="vModalLabel">Online Members</h3>
  </div>
  <div class="modal-body" id="mems_online_body">

  </div>
  <div class="modal-footer">
    <button type="button" data-dismiss="modal" id="close_online_mems" class="btn btn-primary">Ok</button>
  </div>
</div>

{% if canmod %}

<div id="bans" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="vModalLabel" aria-hidden="true">
	<form method="post" id="banform">{% csrf_token %}
	  <div class="modal-header">
	    <button type="button" class="close" id="close_bans2" data-dismiss="modal" aria-hidden="true">×</button>
	    <h3 id="vModalLabel">Ban/Un-ban Members</h3>
	  </div>
	  <input type="hidden" id="ban_list" name="ban_list" />
	  <input type="hidden" id="unban_list" name="unban_list" />
	  <div class="modal-body" id="bans_body">

	  </div>
	  <div class="modal-footer">
	    <button type="submit" name="close_bans" id="close_bans" class="btn btn-primary">Ok</button>
	  </div>
	</form>
</div>

{% endif %}

<div class="container">
    <div id="signinModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
        <h3 id="myModalLabel">Log In</h3>
      </div>
      <form class="form-horizontal centered" style="display:inline-block;" method="post">
          <div class="modal-body"><br>
            <p>This meeting is public. If you don't have an account, you can sign up 
             <a href="/signup/">here</a>.<br><br>If you do have an account, please log in below:</p><br>
                {% csrf_token %}
                {% if login_errors %}
                <div class="control-group">
                    <div class="controls">
                        <h5 style="color: red;">Invalid login credentials</h5>
                    </div>
                </div>
                {% endif %}
                {% if not_verified %}
                <div class="control-group">
                    <div class="controls">
                        <h5 style="color: red;">This account has not yet been verified.</h5>
                    </div>
                </div>
                {% endif %} 
                <input type="hidden" name="submit_request" value="submit_request">
                <div class="control-group">
                    <label class="control-label" for="inputEmail">Email</label>
                    <div class="controls">
                        <input type="text" name="username" class="login" placeholder="email" autocomplete="off">
                    </div>
                </div>
                <div class="control-group">
                    <label class="control-label" for="inputPassword">Password</label>
                    <div class="controls">
                        <input type="password" name="password" class="login" placeholder="password" autocomplete="off">
                    </div>
                </div>
                <div class="control-group">
                    <div class="controls"><!-- 
                        <label class="checkbox">
                            <input type="checkbox"> Remember me
                        </label> -->
                    </div>
                </div>
          </div>
          <div class="modal-footer"><!-- 
            <button type="button" class="btn btn-primary">Login</button>
            <button type="button" class="btn btn-danger">Cancel</button> -->
                <button type="submit" name="login" class="btn btn-primary">Login</button>
                <button type="submit" data-dismiss="modal" class="btn btn-danger">Cancel</button>
          </div>
        </form>
    </div>
</div>

<script>
$(function() {
    $(document).ready(function(){ 

        {% if closed_error %}
        $('#myModal').modal("show");
        {% endif %}

        {% if not user.is_authenticated %}

        {% endif %}

        {% if login_errors %}
        $('#signinModal').modal("show");
        {% endif %}

        {% if not_verified %}
        $('#signinModal').modal("show");
        {% endif %}

    });
});

</script>

<script>

$(document).ready(function() {

	$.ajaxSetup({
	  data: {csrfmiddlewaretoken: '{{ csrf_token }}' },
	});

	var load = true;

	loadOnline();

	$('#submitmsg').click(function() {
		{% if closed %}
		$('#myModal').modal("show");
		{% else %}
		var clientmsg = $('#usermsg').val();
		$.post("/intersub/", {'text': clientmsg, 'meeting': {{m.id}}});
		$('#usermsg').val('');
		{% endif %}
	});

	{% if closed %}
	{% else %}
	function loadLog() {
		var oldscrollHeight = $('#chatbox').prop('scrollHeight') - 20;
		$.ajax({
			url: '/intersub/',
			cache: false,
			data: {'meeting': {{m.id}}},
			success: function(html) {
				$('#chatbox').html(html);

				var newscrollHeight = $('#chatbox').prop('scrollHeight') - 20;
				if (newscrollHeight > oldscrollHeight) {
					$('#chatbox').animate({ scrollTop: newscrollHeight}, 'normal');
				}
			},
		});

	}

	setInterval(loadLog, 1500);

	function loadOnline() {
		if (load) {
			$.getJSON('/chatonline/', {'meeting': {{m.id}}, 'user': {{user.id}}}).done(function(n) {
					$('#n_o').html(n[0]);
					$('#mems_online_body').html(n[1]);
			});
		}
	}

	{% if canmod %}

	function loadBanlist() {
		if (load) {
			$.getJSON('/chatbanlist/', {'meeting': {{m.id}}, 'user': {{user.id}}}).done(function(n) {
					$('#bans_body').html(n[0]);
			});
		}
	}

	loadBanlist();

	setInterval(loadBanlist, 1600);

	$('#see_bans').click(function() {
		load = false;
	});

	$('#close_bans').click(function() {
		load = true;
	});

	$('#close_bans2').click(function() {
		load = true;
	});

	{% endif %}

	$('#see_online_mems').click(function() {
		load = false;
	});

	$('#close_online_mems').click(function() {
		load = true;
	});

	$('#close_online_mems2').click(function() {
		load = true;
	});

	loadOnline();
	setInterval(loadOnline, 1500);

	$(window).bind('beforeunload', function() {
		$.ajax({
			type: "POST",
			async: false,
			url: "/chatonline/",
			data: {'meeting': {{m.id}}, 'user': {{user.id}}}
		});
	});

	$('#banform').submit(function() {
		$('input:checkbox[name=ban_select]:checked').each(function() {
			$('#ban_list').val($('#ban_list').val()+' '+$(this).val());
		});
		$('input:checkbox[name=unban_select]:checked').each(function() {
			$('#unban_list').val($('#unban_list').val()+' '+$(this).val());
		});
	});


	{% endif %}

});

</script>

<script type="text/javascript" src="https://api.cloudsponge.com/address_books.js"></script>

<script>
	var csPageOptions = {
	  domain_key:"RZ7M43JLPAH6JHE45ATN", 
	  textarea_id:"contact_list",
	  ignoreMultipleEmails:true,
	  afterSubmitContacts:function(contacts, source, owner) {
	  		// var oForm = document.getElementById('add_addr_book');
	  		// oForm.submit();
	  		$('#collapse1').collapse('show');
	  }
	};
</script>

{% else %}

<div class="container">
    <div id="myModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
        <h3 id="myModalLabel">This Meeting is Private.</h3>
      </div>
      <form class="form-horizontal centered" style="display:inline-block;" method="post">
          <div class="modal-body"><br>
            <p>If you were invited but don't have an account, you can sign up 
             <a href="/signup/">here</a>.<br><br>If you do have an account, please log in below:</p><br>
                {% csrf_token %}
                {% if login_errors %}
                <div class="control-group">
                    <div class="controls">
                        <h5 style="color: red;">Invalid login credentials</h5>
                    </div>
                </div>
                {% endif %}
                <input type="hidden" name="submit_request" value="submit_request">
                <div class="control-group">
                    <label class="control-label" for="inputEmail">Email</label>
                    <div class="controls">
                        <input type="text" name="username" class="login" placeholder="email" autocomplete="off">
                    </div>
                </div>
                <div class="control-group">
                    <label class="control-label" for="inputPassword">Password</label>
                    <div class="controls">
                        <input type="password" name="password" class="login" placeholder="password" autocomplete="off">
                    </div>
                </div>
                <div class="control-group">
                    <div class="controls"><!-- 
                        <label class="checkbox">
                            <input type="checkbox"> Remember me
                        </label> -->
                    </div>
                </div>
          </div>
          <div class="modal-footer"><!-- 
            <button type="button" class="btn btn-primary">Login</button>
            <button type="button" class="btn btn-danger">Cancel</button> -->
                <button type="submit" name="login" class="btn btn-primary">Login</button>
                <button type="submit" data-dismiss="modal" class="btn btn-danger">Cancel</button>
          </div>
        </form>
    </div>
</div>

<div class="container">
    <div id="vModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="vModalLabel" aria-hidden="true">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
        <h3 id="vModalLabel">This account has not been verified.</h3>
      </div>
      <form class="form-horizontal centered" style="display:inline-block;" method="post">
          <div class="modal-body"><br>
            <p>This account has not yet been verified--a verification email was sent to you.</p><br>
          <div class="modal-footer">
                <a href='/' type="submit" name="login" class="btn btn-primary">Go to home</a>
          </div>
        </form>
    </div>
</div>

<script>

$(document).ready(function() {
    {% if not_verified %}
    $('#vModal').modal("show");
    {% else %}
    $('#myModal').modal("show");
    {% endif %}
});

</script>

{% endif %}

{% endblock %}